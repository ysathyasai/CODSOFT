<!-- templates/index.html -->
<!--
  Simple chat UI served by Flask. This frontend lets the user type messages and
  displays bot responses. It sends POST requests to /chat and expects a JSON
  object with a `reply` field.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Rule-based Chatbot</title>
  <!-- Inline CSS moved here for simpler distribution. This block styles the UI
    to resemble a WhatsApp-like chat: green header, rounded message bubbles,
    and a compact input area. Keeping CSS inside the template as requested. -->
  <style>
  :root{
    /* Light mode variables */
    --bg:#e5ddd5;
    --chat-bg:#f8f9fa;
    --wh-green:#25D366;
    --muted:#667085;
    --user:#DCF8C6;
    --bot:#FFFFFF;
    --text:#0f172a;
    --topbar-grad-start:#075E54;
    --topbar-grad-end:#128C7E;
    --shell-bg:#ffffff;
  }

  /* Dark mode: applied when body has class 'dark' */
  body.dark {
    --bg:#0b1410; /* page background */
    --chat-bg:#0f1720; /* message list bg */
    --wh-green:#06d755;
    --muted:#9aa6b2;
    --user:#113b11;
    --bot:#0d1113;
    --text:#e6eef8;
    --topbar-grad-start:#052b22;
    --topbar-grad-end:#0a6b5a;
    --shell-bg:#071013;
  }
  /* In dark mode use a solid topbar color (no gradient) for a consistent dark header */
  body.dark .topbar { background: var(--topbar-grad-start); }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);display:flex;align-items:center;justify-content:center;min-height:100vh}
  .chat-shell{width:100%;max-width:960px;height:86vh;background:var(--shell-bg);border-radius:12px;display:flex;overflow:hidden;box-shadow:0 6px 20px rgba(16,24,40,0.12)}
  /* Left column (phone-like) */
  .phone{flex:1;display:flex;flex-direction:column}
  .topbar{background:linear-gradient(90deg,var(--topbar-grad-start),var(--topbar-grad-end));color:var(--text);padding:14px 16px;display:flex;align-items:center;gap:12px}
  .topbar, .muted { color: var(--text); }
  /* Title should always be white for clear branding */
  .title { color: #ffffff !important; }
  .topbar .avatar{width:42px;height:42px;border-radius:50%;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--text)}
  .mode-toggle{margin-left:auto;background:transparent;border:none;color:var(--text);cursor:pointer;font-size:1.1rem;padding:6px;border-radius:8px}
  .mode-toggle:focus{outline:2px solid rgba(255,255,255,0.12)}
  .topbar .title{font-size:1rem;font-weight:600}
  /* Messages container: use column flex so each message stacks vertically
    and spacing (gap) controls distance between messages. This ensures user
    and bot messages don't sit side-by-side. */
  .messages{flex:1;padding:18px;overflow:auto;background:linear-gradient(180deg,var(--chat-bg) 0%, #f1f3f4 100%);display:flex;flex-direction:column;gap:12px}

  /* Message bubbles: make them block-level so they take available width
    and can be aligned using align-self on the parent flex column. */
  .message{max-width:78%;padding:10px 12px;border-radius:12px;display:block;word-break:break-word;color:var(--text)}
  .message .time{display:block;font-size:11px;color:var(--muted);margin-top:8px;text-align:right}
  .message.bot{background:var(--bot);align-self:flex-start;border-bottom-left-radius:6px}
  .message.user{background:var(--user);align-self:flex-end;border-bottom-right-radius:6px}
  .composer{display:flex;padding:12px;border-top:1px solid rgba(255,255,255,0.04);gap:8px;align-items:center;background:transparent}
  .composer input{flex:1;padding:12px;border-radius:24px;border:1px solid rgba(0,0,0,0.06);font-size:1rem;background:rgba(255,255,255,0.02);color:var(--text)}
  .composer input::placeholder{color:var(--muted)}
  .send-btn{background:var(--wh-green);color:#fff;padding:10px 14px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .muted{color:var(--muted);font-size:0.85rem}
  .typing{font-style:italic;color:var(--muted);padding:8px 12px;border-radius:12px;display:inline-block;background:rgba(0,0,0,0.03)}
  /* Mobile-specific adjustments: make the chat shell full-height, tighten
     paddings and increase touch targets for composer controls. */
  @media (max-width:700px) {
    .chat-shell { height: 100vh; max-width: 100%; border-radius: 0; }
    .topbar { padding: 12px; }
    .topbar .avatar { width: 36px; height: 36px; }
    .messages { padding: 12px; gap:10px }
    .composer { padding: 10px; }
    .composer input { padding: 12px; font-size: 1rem; }
    .send-btn { padding: 10px; width:44px; height:44px }
  }
  </style>
</head>
<body>
  <div class="chat-shell">
    <div class="phone" role="application" aria-label="Chat window">
      <div class="topbar">
        <div class="avatar">CB</div>
        <div>
          <div class="title">Chatbot</div>
          <div class="muted">rule-based • online</div>
        </div>
        <!-- Dark mode toggle button (sun/moon) -->
        <button id="mode-toggle" class="mode-toggle" aria-pressed="false" title="Toggle dark mode">🌙</button>
      </div>

      <!-- Messages area where conversation bubbles will appear -->
      <div id="messages" class="messages" aria-live="polite"></div>

      <!-- Composer - similar to WhatsApp input style -->
      <form id="chat-form" class="composer" aria-label="Send message form">
        <input id="message-input" type="text" autocomplete="off" placeholder="Type a message" aria-label="Message input" />
        <button class="send-btn" aria-label="Send message" title="Send">➤</button>
      </form>
    </div>
  </div>

  <script>
    // Frontend JavaScript: handles form submission and updating the UI.

    // Helper: create a message bubble and append it to the messages container
    function appendMessage(text, sender='bot') {
      const messages = document.getElementById('messages');
      const bubble = document.createElement('div');
      bubble.className = 'message ' + sender; // 'message bot' or 'message user'

      // Include a timestamp for small UX nicety
      const time = new Date().toLocaleTimeString();
      bubble.innerHTML = `<div class="text">${escapeHtml(text)}</div><div class="time">${time}</div>`;

      messages.appendChild(bubble);
      messages.scrollTop = messages.scrollHeight; // auto-scroll to the latest message
    }

    // Simple HTML escape to avoid injection when showing messages
    function escapeHtml(unsafe) {
      return unsafe
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Setup the form submit handler
    document.getElementById('chat-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      if (!message) return;

      // Show the user's message immediately
      appendMessage(message, 'user');

      // Clear input for the next message
      input.value = '';
      input.focus();

      // Send the message to the backend using fetch. Expect JSON {reply: '...'}
      try {
        const resp = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message })
        });

        if (!resp.ok) {
          // If server returns an error status, show a friendly message
          appendMessage('Sorry, something went wrong on the server.', 'bot');
          return;
        }

        const data = await resp.json();
        appendMessage(data.reply, 'bot');
      } catch (err) {
        // Network or unexpected error
        appendMessage('Network error: could not reach the server.', 'bot');
        console.error(err);
      }
    });

    // Optional: show a greeting from the bot on load
    window.addEventListener('load', () => {
      appendMessage('Hello! I\'m your friendly rule-based chatbot. Try saying "Hi" or "Tell me a joke".');
    });
    
    // Dark mode toggle: persist preference in localStorage and apply class to body
    (function() {
      const toggle = document.getElementById('mode-toggle');
      const storageKey = 'chat_dark_mode';

      function applyMode(isDark) {
        if (isDark) {
          document.body.classList.add('dark');
          toggle.textContent = '☀️';
          toggle.setAttribute('aria-pressed', 'true');
        } else {
          document.body.classList.remove('dark');
          toggle.textContent = '🌙';
          toggle.setAttribute('aria-pressed', 'false');
        }
      }

      // Initialize from localStorage (default false)
      const stored = localStorage.getItem(storageKey);
      const initialDark = stored === '1' || stored === 'true';
      applyMode(initialDark);

      // Toggle on click and persist
      toggle.addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem(storageKey, isDark ? '1' : '0');
        applyMode(isDark);
      });
    })();
  </script>
</body>
</html>
